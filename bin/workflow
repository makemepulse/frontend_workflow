#!/usr/bin/env node
'use strict'

const fs     = require('fs-extra')
const subarg = require('subarg')
const spawn  = require('child_process').spawn

const requiredir = require('../lib/require_dir')
const Lib        = requiredir(`lib`)
const options    = subarg(process.argv.slice(2), {})
const action     = options._[0]

let pkg = fs.readJsonSync(`${process.cwd()}/package.json`)
if (pkg.frontend_workflow) {
  options.workflow_path = pkg.frontend_workflow.path
  options.workflow_name = pkg.frontend_workflow.name
}

if (!options.workflow_name && !options.workflow_name) {
  Lib.print.log(`Workflow name and path are missing!`, true, 'yellow')
  return
}

switch (action) {
  case 'setup':
  case 'setup:run': {
    Lib.setup.run(options)
    break;
  }
  case 'commands-list': {
    Lib.setup.commandList(options)
    break;
  }
  default: {

    let args = process.argv.join(' ').split(action)[1].replace(/^(\s|\n)+|(\s|\n)+$/g, '').split(' ')
    args.unshift(action)
    args.unshift(`${options.workflow_path}/${options.workflow_name}`)

    let params = []
    for (var i = 0; i < args.length; i++) {
      if (!args[i].match(/workflow_/gi)) {
        params.push(args[i])
      }
    }

    try {
      const Tasks = requiredir(`${options.workflow_path}/${options.workflow_name}/tasks`, true)
      if (Tasks.hasOwnProperty(action)) {
        spawn('node', params, {stdio:'inherit'})
        return
      }
    } catch(e) {}

    spawn('node', params, {stdio:'inherit'})
  }
}
